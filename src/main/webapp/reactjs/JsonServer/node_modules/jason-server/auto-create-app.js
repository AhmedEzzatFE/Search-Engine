const bodyParser = require('body-parser')
const express = require('express')
const cors = require('cors')
const multipart = require('connect-multiparty')
const {setConfig,getConfig} = require('./core/config')


const autoCreateServer = ({setParamsMiddleWare, customMiddlewares = []}) => {
    const uploadMiddleware = require('./middlewares/upload-img-middleware').uploadMiddleware;
    const servicePreMiddleware = require('./middlewares/service-pre-middleware').servicePreMiddleware;
    const matchAPIMiddleware = require('./middlewares/match-api-middleware').matchAPIMiddleware;

    const app = express();
    app.use(cors())
    app.use(bodyParser.json({limit: '50mb'}))
    app.use(bodyParser.urlencoded({extended: true}))
    app.use(setParamsMiddleWare);
    const multipartMiddleware = multipart();
    app.use(multipartMiddleware, uploadMiddleware)
    app.use(servicePreMiddleware)
    app.use(matchAPIMiddleware)
    customMiddlewares.map(middelware => app.use(middelware))

    //监听request
    app.listen(getConfig('ENV').PORT, () => {
        console.log('Express: listening on ' + getConfig('ENV').PORT)
    })

}

module.exports = {
    autoCreateServer
}