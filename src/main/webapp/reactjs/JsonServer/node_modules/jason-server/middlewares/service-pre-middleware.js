const {equals, contains} = require('ramda')
const {getConnection, SYS_AUTO_API_PREFIX} = require('../core/util')
const {setPreContext, checkPreContext} = require('./pre-context')
const {getConfig} = require('../core/config')
const {services} = require('../core/services')

const servicePreMiddleware = async (req, res, next) => {
    //对比请求来源是否校验，不校验即刻报无权限
    const funName = req.funName;
    const {ignoreCheckToken} = services[funName]

    if (ignoreCheckToken || contains(funName, getConfig('IGORE_TOKEN_FUN') || [])) {
        console.log('IGORE TOKEN FUN IS ' + funName)
    } else {
        const isCheckedToken = checkPreContext(req, req.token)
        if (!req.token) return res.json({code: 406, data: {error: '请将token挂载在请求上，如req.token = token'}})
        if (!isCheckedToken) return res.json({code: 405, data: {error: 'token 校验失败'}})
    }
    //注入数据库连接
    let conn = await getConnection();
    req.body.conn = conn;
    next()
}

module.exports = {servicePreMiddleware}